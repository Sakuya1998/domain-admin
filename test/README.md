# API 接口测试

本目录包含了 domain-admin 项目的 API 接口测试用例。

## 测试覆盖范围

### 1. 认证测试
- 管理员登录测试
- 普通用户登录测试
- 无效token访问测试
- 无Authorization头访问测试

### 2. 用户注册测试
- 用户注册（无Role字段，验证默认值）
- 用户注册（有Role字段）
- 参数验证错误测试

### 3. 用户资料管理测试
- 获取用户资料
- 更新用户资料

### 4. 管理员功能测试
- 获取用户列表
- 创建用户
- 更新不存在的用户（404错误）
- 删除不存在的用户（404错误）

### 5. 权限验证测试
- 普通用户访问管理员接口（403错误）

### 6. 性能测试
- 管理员登录性能基准测试
- 用户资料获取性能基准测试

## 运行测试

### 前置条件
1. 确保主应用程序已启动并运行在 `http://localhost:8000`
2. 数据库已正确配置并包含默认管理员账户（admin/password）

### 运行所有测试
```bash
cd test
go test -v
```

### 运行特定测试
```bash
# 运行单个测试
go test -v -run TestAdminLogin

# 运行匹配模式的测试
go test -v -run "Test.*Login"
```

### 运行性能测试
```bash
# 运行所有基准测试
go test -bench=.

# 运行特定基准测试
go test -bench=BenchmarkAdminLogin
```

### 生成测试报告
```bash
# 生成覆盖率报告
go test -cover

# 生成详细覆盖率报告
go test -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

## 测试结果说明

所有测试用例均验证以下方面：
- HTTP状态码正确性
- 业务错误码正确性
- 响应消息格式
- 数据完整性
- 权限控制

## 修复的问题

1. **用户注册Role字段处理**：修复了注册时Role字段为空时的默认值设置
2. **中间件错误响应格式**：统一了认证中间件的错误响应格式
3. **用户不存在时的错误码**：修复了用户不存在时返回的错误码
4. **HTTP状态码与业务错误码匹配**：确保HTTP状态码与业务错误码保持一致

## 技术改进

- 错误处理标准化
- 参数验证优化
- 权限控制完善
- 响应格式统一
- 状态码规范化